# # ПРАВИЛЬНОЕ ОПРЕДЕЛЕНИЕ FIX-PREFIX ПАТТЕРНА
# Извлечено из baza.txt (строки 5-64)
# Дата создания: 2025-08-29 19:03:09
# Обновлено: 2025-08-29 - уточнение по направлению паттерна

# ПРАВИЛЬНОЕ ОПРЕДЕЛЕНИЕ FIX-PREFIX ПАТТЕРНА
# =============================================================================

## FIX-PREFIX - РАЗВОРОТНАЯ МОДЕЛЬ

**ФИКС-ПРЕФИКС** - это универсальная разворотная модель паттерна, которая чаще всего возникает в конце трендового движения и работает в обе стороны (лонг и шорт). На данном этапе разработки мы фокусируемся на ШОРТОВЫХ моделях для отработки алгоритма детекции.

### ПОСЛЕДОВАТЕЛЬНОСТЬ ФОРМИРОВАНИЯ FIX-PREFIX (на примере шортовой модели):

#### 1. FIX ОБЛАСТЬ (ПЛАТО FIX)
- Цена из флэта идет наверх
- Образует вершину - ПЛАТО FIX (область консолидации на вершине)
- Это зона накопления Smart Money для будущих продаж

#### 2. ВЫХОД ВНИЗ ИЗ FIX
- После FIX цена выходит вниз
- Идет какое-то время вниз, образуя ЛОЙ-FIX
- ЛОЙ-FIX = самый низкий LOW после выхода из FIX области

#### 3. ВОЗВРАТ ВЫШЕ FIX
- Цена идет вверх выше области FIX
- Как только цена прошла выше FIX, фиксируем ЛОЙ-FIX
- ЛОЙ-FIX = самый низкий лой между областью FIX и текущей ценой
- **ЭТОТ ЛОЙ-FIX ОЧЕНЬ ВАЖЕН - ОН ВАЛИДИРУЕТ ПАТТЕРН**

#### 4. HI-PATTERN (ВЕРШИНА)
- Цена идет еще выше (всегда по-разному - высота взлета варьируется)
- Формирует Hi-pattern (вершину разворота)
- После Hi-pattern цена разворачивается вниз

#### 5. RAY (ЛУЧ ВАЛИДАЦИИ)
- Как только цена от Hi-pattern пошла вниз, рисуем RAY вправо от ЛОЙ-FIX
- RAY = горизонтальная линия от самого низкого лоя между FIX и Hi-pattern
- **!!! ЭТОТ RAY БУДЕТ ВАЛИДИРОВАТЬ ВЕСЬ ПАТТЕРН !!!**

**ВАЖНЫЕ УТОЧНЕНИЯ ПО RAY:**
- **RAY - ЭТО ВАЛИДАЦИЯ ПАТТЕРНА**, а не просто отрезок!
- RAY строится ТОЛЬКО после того, как цена пошла вниз от HI-PATTERN (минимум 2 свечи закрылись ниже)
- RAY отходит от самого низкого лоя МЕЖДУ FIX и HI-PATTERN
- **КАК ТОЛЬКО ЦЕНА ОБНОВИЛА RAY СВЕРХУ-ВНИЗ - ПАТТЕРН ВАЛИДИРОВАН!**
- Визуально: RAY подпись располагается по центру луча, над линией

#### 6. ВАЛИДАЦИЯ ПАТТЕРНА
- Цена идет ниже, проходит по высоте область FIX
- **КАК ТОЛЬКО ЦЕНА ПРОЙДЕТ СВЕРХУ-ВНИЗ УРОВЕНЬ RAY (ОБНОВИТ ЕГО) ХОТЯ БЫ НА 1-2 ТИКА**
- **ТОГДА ПАТТЕРН ВАЛИДИРУЕТСЯ И ОПРЕДЕЛЯЕТСЯ ОБЛАСТЬ PREFIX**

#### 7. PREFIX ОБЛАСТЬ (ЦЕЛЕВАЯ ЗОНА) - ДЕТАЛЬНАЯ РЕАЛИЗАЦИЯ

**ВАЖНЫЕ ХАРАКТЕРИСТИКИ PREFIX:**
- **Расположение**: PREFIX находится на том же ценовом уровне что и FIX область (744.64-748.40)
- **Высота**: PREFIX равен по высоте области FIX (идентичные верхняя и нижняя границы)
- **Время появления**: PREFIX появляется СТРОГО с момента валидации RAY паттерна
- **Начальная позиция**: Начинается с индекса свечи валидации RAY (не раньше!)

**ЛОГИКА ЗАВЕРШЕНИЯ PREFIX:**
- PREFIX активен пока цена периодически возвращается в эту зону
- PREFIX заканчивается когда 10 свечей подряд НЕ возвращались в зону
- Критерий завершения: `candle.high > fix_low_price` сбрасывает счетчик возвратов
- Только после 10 свечей без возврата PREFIX считается неактивным

**ТОРГОВОЕ ЗНАЧЕНИЕ:**
- PREFIX = активная зона для шортовых входов
- Пока цена периодически возвращается - зона работает
- Длительность PREFIX: обычно 15-25 свечей на M15 таймфрейме

#### 8. BA25 (БЕЗУБЫТОК 25%)
- Самый нижний лой между Hi-pattern и PREFIX = зона безубытка (М5, М15 ТФ)
- От этого лоя откладываем луч вправо
- При возврате цены к этому уровню: закрываем 25% позиции + остальное в безубыток

#### 9. TAKE PROFIT
- Зона Take Profit ≈ уровень начала движения в зону FIX

### ТОРГОВАЯ ЛОГИКА:
- **Вход:** Лимитники в области PREFIX (шорт)
- **Стоп:** Выше PREFIX области
- **Частичная фиксация:** BA25 (25% позиции)
- **Полная фиксация:** Уровень начала движения к FIX

## ДЕТАЛЬНАЯ STATE MACHINE ДЛЯ ДЕТЕКЦИИ FPF

### Состояния детектора:
```python
class FPFState(Enum):
    IDLE = "idle"                    # Ожидание начала паттерна
    FIX_FORMING = "fix_forming"      # Формируется зона консолидации
    FIX_COMPLETED = "fix_completed"  # FIX сформирован, ждем RAY
    RAY_BUILDING = "ray_building"    # Строится луч поддержки/сопротивления  
    PREFIX_ACTIVE = "prefix_active"  # Зона ретеста активна
    IMPULSE_DETECTED = "impulse_detected"  # Импульс подтвержден
    PATTERN_COMPLETE = "pattern_complete"  # Паттерн завершен
    PATTERN_FAILED = "pattern_failed"      # Паттерн сломался
```

### Контекст паттерна:
Каждый паттерн содержит полную информацию о своем состоянии:

#### FIX Характеристики:
- `fix_high/fix_low` - границы FIX области
- `fix_start_time/fix_end_time` - временные рамки
- `fix_consolidation_range` - размер диапазона в % от цены
- `fix_average_volume` - средний объем в FIX
- `fix_touch_count` - количество касаний границ

#### RAY Характеристики:
- `ray_level` - уровень RAY (от LOY-FIX)
- `ray_validation_time` - момент валидации паттерна
- `ray_touch_count` - количество тестов уровня
- `ray_strongest_test` - самое близкое касание

#### IMPULSE Метрики:
- `impulse_start_price/impulse_peak_price` - цены начала и пика
- `impulse_volume_surge` - во сколько раз больше среднего
- `impulse_speed` - скорость движения (% за минуту)

#### Качественные оценки:
- `pattern_quality_score` - общая оценка (0-1)
- `risk_reward_ratio` - соотношение риск/прибыль
- `confidence_level` - уверенность в паттерне

### КРИТЕРИИ ПЕРЕХОДА МЕЖДУ СОСТОЯНИЯМИ

#### 1. IDLE → FIX_FORMING
**Критерии старта:**
- Цена достигла локального экстремума (swing high/low)
- Объем на экстремуме >1.5x среднего
- Последующие 5 свечей в диапазоне <0.8%
- Отсутствие сильных новостных событий

#### 2. FIX_FORMING → FIX_COMPLETED
**Критерии завершения FIX:**
- Минимальное время формирования (10 свечей M5, 5 свечей M15)
- Качество консолидации >60%
- Снижение объема (накопление завершено)
- Готовность к пробою >70%

#### 3. FIX_COMPLETED → RAY_BUILDING
**Критерии построения RAY:**
- Цена вышла из FIX области
- Сформирован LOY-FIX (самый низкий лой между FIX и HI-PATTERN)
- Цена пошла выше FIX, образовав HI-PATTERN
- Минимум 2 свечи после HI-PATTERN закрылись ниже

#### 4. RAY_BUILDING → PREFIX_ACTIVE
**Критерии валидации RAY:**
- Цена пробила RAY уровень сверху-вниз на 2+ тика
- Паттерн считается валидированным
- Определяется область PREFIX

## СИСТЕМА ФИЛЬТРАЦИИ СИГНАЛОВ

### Веса фильтров:
- **ATR фильтр (25%)** - адаптация к волатильности
- **Volume фильтр (30%)** - объемный анализ (самый важный!)
- **Session фильтр (15%)** - временной контекст
- **Level фильтр (20%)** - качество уровней
- **Multi-TF фильтр (10%)** - подтверждение на других ТФ

### Классификация сигналов:
- **PREMIUM (≥80%)** - торгуем большими объемами
- **STANDARD (60-79%)** - торгуем средними объемами
- **WEAK (40-59%)** - торгуем малыми объемами
- **REJECTED (<40%)** - не торгуем

## СИСТЕМА УРОВНЕЙ

### Типы уровней:
1. **HOD/LOD** - психология дневных экстремумов
2. **POC** - объемные уровни справедливой цены
3. **VWAP** - институциональный бенчмарк
4. **Swing Levels** - разворотные точки тренда

### POC (Point of Control):
**Философия:** Показывает где Smart Money принимал важные решения
- Расчет через ценовые бины (0.1% от диапазона сессии)
- Value Area = 70% объема вокруг POC
- Магнетизм: цена стремится к POC при отклонении >2%

### VWAP Стратегии:
- **Mean Reversion:** при отклонении >2% от VWAP
- **Trend Following:** цена рядом с трендующим VWAP

# =============================================================================